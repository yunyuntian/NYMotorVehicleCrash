<!DOCTYPE html>
<head>
  <title>6. Interactive Components</title>
</head>
<meta charset="utf-8">
<style>

.background {
  fill: #eee;
  pointer-events: all;
}

.map-layer {
  fill: #fff;
  stroke: #aaa;
}

.effect-layer{
  pointer-events:none;
}

text{
  font-family: "Times New Roman", Times, serif;
}

text.big-text{
  font-size: 23px;
  font-weight: 400;
}

text.title_text{
  font-size: 25px;
  font-weight: 400;
}

text.instruction_text{
  font-size: 16px;
  fill: grey;
}
  
.effect-layer text, text.dummy-text{
  font-size: 12px;
}

</style>
<body>
<svg></svg>
<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  
<script>
  
var width = 960,
    height = 500,
    centered;

// Define projection of the graph 
var projection = d3.geo.mercator()
  .scale(45000)
  // Center the Map in NY
  .center([-73.935242, 40.730610])
  .translate([width / 2, height / 2]);

// Define path of the projection to follow 
var path = d3.geo.path()
  .projection(projection);

// Set svg width & height
var svg = d3.select('svg')
  .attr('width', width)
  .attr('height', height);

// Add background
svg.append('rect')
  .attr('class', 'background')
  .attr('width', width)
  .attr('height', height);

// Add layers
var g = svg.append('g');

var effectLayer = g.append('g')
  .classed('effect-layer', true);

var mapLayer = g.append('g')
  .classed('map-layer', true);

// Create legend axis  
var legendaxis = d3.axisRight()
	.scale(colorScale4)

// Text for borough names
var bigText = g.append('text')
  .classed('big-text', true)
  .attr('x', 650)
  .attr('y', 70);

// Title
var title = g.append('text')
  .classed('title_text', true)
  .attr('x', 20)
  .attr('y', 40)
	.text("2021 New York City Car Collison Analysis by Borough");

// Instructions
var instruction = g.append('text')
  .classed('instruction_text', true)
  .attr('x', 20)
  .attr('y', 70)
	.text("Instruction")
  .append('tspan')
  .attr('x', 20)
  .attr('y', 90)
	.text("1. Each borough is color-coded by its total number of car accidents")
  .append('tspan')
  .attr('x', 20)
  .attr('y', 110)
	.text("2. Hover the mouse over a borough to see more details");
  
// Load map data using pre-generated geojson package
d3.json('nyc.geojson', function(error, mapData) {
  var features = mapData.features;

  // Update color scale domain based on data
  color.domain([0, d3.max(features, totalCount)]);

  // Draw each borough as a path
  mapLayer.selectAll('path')
      .data(features)
      .enter().append('path')
      .attr('d', path)
      .attr('vector-effect', 'non-scaling-stroke')
      .style('fill', fillFn)
      .on('mouseover', mouseover)
      .on('mouseout', mouseout);
});
  
// Add Scale 
var scale = g.append('text')
  .attr('x', 20)
  .attr('y', 230)
	.text("Scale of Total Car Collisions:")

var totalCaseText = g.append('text')
  .attr('x', 700)
  .attr('y', 300);
  
var severeCaseText = g.append('text')
  .attr('x', 700)
  .attr('y', 320);

var avgtotalText = g.append('text')
  .attr('x', 650)
  .attr('y', 100);
  
var avgsevereText = g.append('text')
  .attr('x', 650)
  .attr('y', 120);

var ldcauseText = g.append('text')
  .attr('x', 650)
  .attr('y', 140);
  
  
// Define functions  

// Get borough name
function nameFn(d){
  return d && d.properties ? d.properties.boro_name : null;
}

// Get borough total case
function totalCount(d){
  var n = nameFn(d);
  return hovercase[n][0];
}
  

// Get borough color
function fillFn(d){
  return color(totalCount(d));
}
  

// event while hover mouse on graph 
function mouseover(d){
  // Highlight hovered borough
  d3.select(this).style('fill', '#D5708B');

  // Draw effects
  textArt(nameFn(d));
  reportCase(nameFn(d));
  updateDetails(nameFn(d));
}

// event while hover mouse out of graph
function mouseout(d){
  // Reset borough color
  mapLayer.selectAll('path')
    .style('fill', function(d){return centered && d===centered ? '#D5708B' : fillFn(d);});

  // Remove effect text
  effectLayer.selectAll('text').transition()
    .style('opacity', 0)
    .remove();
}

// data neccessary for plotting
// 0.#total, 1.#severe, 2.severe_rate, 3.avg total, 4.avg severe, 5.top3 leading cause 6. expected cases
var hovercase = {
  "Staten Island": [497,156,31.39,1.6,0.5,'Distracted driving (40.9%)', 0.461],
  "Brooklyn": [3171,1228,38.73,10.4,4.0,'Distracted driving (39.88%)', 0.509],
  "Bronx": [1761,650,36.92,5.8,2.1,'Distracted driving (32.68%)', 0.496],
  "Manhattan": [1720,657,38.20,5.6,
2.2, 'Distracted driving (39.21%)', 0.516],
  "Queens": [2837,1059,37.33,9.3,3.5,'Distracted driving (33.3%)',0.433]
};

// Define color scale
var colorScale4 = d3.scaleSequential(d3.interpolateGnBu)
  .domain([0, 3500]);  
  
// Define color scale
var color = d3.scale.linear()
  .domain([1, 4000])
  .clamp(true)
  .range(['#fff', '#409A99']);


var linear = d3.scaleLinear()
  .domain([0,4000])
  .clamp(true)
  .range(['#fff', '#409A99']);

var svg = d3.select("svg");

svg.append("g")
  .attr("class", "legendLinear")
  .attr("transform", "translate(50,250)");

var legendLinear = d3.legendColor()
  .shapeWidth(30)
  .cells([1000,2000,3000,4000])
  .labels([ "<1000",
             "1000~1999",
             "2000~2999",
             "â‰¥3000"])
  .orient('vertical')
  .scale(linear);

svg.select(".legendLinear")
  .call(legendLinear);

// Show Borough Name
function textArt(text){
  // Set the font for the Borough text on upper right
  bigText.text(text);
}


// Report number of cases and severe cases of collision
function reportCase(text){

  avgtotalText
    .text("Avg Daily Cases: " + hovercase[text][3]);
  avgsevereText
    .text("Avg Daily Severe Cases: " + hovercase[text][4]);
  ldcauseText
    .text("Primary Cause: " + hovercase[text][5]);
  
}	
  

  
// percentage bars and associated texts, numbers
var wScale = d3.scaleLinear()
    .domain([-1, 1])
    .range([-200, 200]);

var details_layer = svg.append("g")
    .attr("id", "details")
    .attr("transform", "translate(700, 300)");

 
details_layer.append("text")
    .attr("id", "cityLegend")
    .text("Average # of injured / killed")
    .attr("transform", "translate(5, -30)");  
  
var kiPeople = details_layer
  .append("text")
  	.text("")
  	.attr("x", 80)
  	.attr("y", -4)
  ;
  
var detailsBars = details_layer.selectAll("bar")
    .data([0.5001, -0.4999])
    .enter()
    .append("g")
    .attr("class", "bar");

var right = details_layer
    .append("rect")
    .attr("width", 100)
    .attr("height", 20)
    .attr("x", 100)
    .attr("y", 10)
    .style("fill", "#409A99");
    
var left =  details_layer
    .append("rect")
    .attr("width", 100)
    .attr("height", 20)
    .attr("y", 10)
    .attr("x", 0)
    .style("fill", "#D5708B");
  
details_layer
  .append("text")
  	.text("Severe")
  	.attr("x",28)
  	.attr("y", 50)
  ;
  
details_layer
  .append("text")
  	.text("Light")
  	.attr("x",135)
  	.attr("y", 50)
  ; 

var severe = details_layer
  .append("text")
  	.text("50.00%")
  	.attr("x",28)
  	.attr("y", 70)
  ;
  
var light = details_layer
  .append("text")
  	.text("50.00%")
  	.attr("x",132)
  	.attr("y", 70)
  ;
  
function updateDetails(d) {
	severe_rate = hovercase[d][2]
	light_rate = 100 - severe_rate
	borough = d
  expected_count = hovercase[d][6]
  left
      .transition()
      .duration(500)
      .attr("width", severe_rate*2);
  
  right
      .transition()
      .duration(500)
  		.attr("x",severe_rate *2)
      .attr("width", 200 -severe_rate *2 );
  
  severe.text(severe_rate + "%");
	
  light.text(light_rate + "%");
  
  kiPeople.text(expected_count)
  }

</scrip